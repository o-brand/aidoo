{% extends 'base.html' %}
{% load static %}

{% block title %}My profile{% endblock %}

{% block head_extra %}
<script src="{% static 'js/htmx-1.8.5.min.js' %}" defer></script>
<script src="{% static 'js/hyperscript-0.9.7.min.js' %}" defer></script>
{% endblock %}

{% block content %}
{% include 'navigation.html' %}
  
<div class="container my-4">
  
  <h1>My username: {{ user.username }}</h1>

  <div class="tab">
    <button class="tablinks" id="details_tab">Personal details</button>
    <button class="tablinks" id="saved_tab">Bookmarked jobs</button>
    <button class="tablinks" id="applied_tab">Applied jobs</button>
    <button class="tablinks" id="posted_tab">Posted jobs</button>
  </div>

  <div id="details" class="tabcontent">
    <div class="d-flex justify-content-between">
      <h3>Personal details</h3>
      <button class="btn btn-secondary">Edit</button> <!--Not connected to anything yet-->
    </div>
    <p><img src="../static/assets/pfp/{{user.id}}.jpeg" class="profile-pic img-fluid"/></p>
    <p>Real name: {{ user.first_name }} {{ user.last_name }}</p>
    <p>Email address: {{ user.email }}</p>
    <p>Date of birth: {{ user.date_of_birth }}</p>

    <p>Balance: {{ user.balance }} points</p>
    <p>Rating: {{ user.rating }}</p>

    <p>Last logged in: {{ user.last_login }}</p>
    <p>Joined: {{ user.date_joined }}</p>
  </div>

  <div id="saved" class="tabcontent">
    <h3>Bookmarked jobs</h3>
    {% if saved %}
        <div>
            {% for job, time in saved %}
              {% if not job.hidden %}
                <p>
                    <a href="{% url 'jobdetails' job.job_id %}">{{ job.job_title }}</a> ({{job.points}} points)
                    <br>Saved at {{ time }}
                </p>
              {% endif %}
            {% endfor %}
        </div>
    {% else %}
        <p>I don't have any saved jobs.</p>
    {% endif %}
  </div>

  <div id="applied" class="tabcontent">
    <h3>Applied jobs</h3>
    {% if applied %}
      {% for job, status in applied %}
        <div>
          <a href="{% url 'jobdetails' job.job_id %}">{{ job.job_title }}</a> ({{job.points}} points)
          <p>Posted on: {{ job.posting_time }}</p>
          <span>
            {% include 'htmx/job-applied.html' %}
          </span>
          <hr>
        </div>
      {% endfor %}
    {% else %}
        <p>I haven't applied for any jobs.</p>
    {% endif %}
  </div>

  <div id="posted" class="tabcontent">
    <h3>Posted jobs</h3>
    {% if posted %}
      {% for job, applicants in posted %}
        <div>
          <a href="{% url 'jobdetails' job.job_id %}">{{ job.job_title }}</a> ({{job.points}} points)
          <p>Posted on: {{ job.posting_time }}</p>
          {% if not job.completed %}
            <h6>Applicants:</h6>
            {% if applicants %}
              {% if not job.assigned %}
                <form method="post" action="{% url 'me' %}" id="applicant-{{job.job_id}}">
                  {% csrf_token %}
                  <select name="accept" id="option-{{job.job_id}}"class="select">
                    <option disabled selected value="-1">Select somebody</option>
                    {% for applicant in applicants %}
                      {% if applicant.status == "AP" %}
                        <option value="{{ applicant.applicant_id.id }}">{{ applicant.applicant_id.username }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                  <input type="hidden" value='accept' name="kind">
                  <input type="hidden" value='{{job.job_id}}' name="accepted" >
                  <button type="submit" class = "btn btn-primary" disabled id="accept-{{job.job_id}}">Accept</button>
                </form>
              {% else %}
                {% for applicant in applicants %}
                  {% if applicant.status == "AC" %}
                    <p>{{ applicant.applicant_id.username }}: <a href="mailto:{{ applicant.applicant_id.email }}">{{ applicant.applicant_id.email }}</a></p>
                    <form method="post" action="{% url 'me' %}">
                      {% csrf_token %}
                      <input type="hidden" value='{{job.job_id}}' name="jid">
                      <input type="hidden" value='{{applicant.applicant_id.id}}' name="appid">
                      <input type="hidden" value='exchange' name="kind">
                      <button type="submit" class="btn btn-primary" id="close{{job.job_id}}">Job Done</button>
                    </form>
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% else %}
              <p>No one has applied for this job yet.</p>
            {% endif %}
          {% else %}
            <p>This job is complete.</p>
          {% endif %}
        </div>
        <hr>
      {% endfor %}
    {% else %}
        <p>I haven't posted any jobs.</p>
    {% endif %}
  </div>
  <br/>
  <p><a href="{% url 'home' %}">Go back</a></p>
</div>

<script src="{% static 'js/private.js' %}"></script>
{% endblock %}