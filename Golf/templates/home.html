{% extends 'base.html' %}
{% load static %}

{% block title %}Home{% endblock %}

{% block head_extra %}
<script src="{% static 'js/htmx-1.8.5.min.js' %}"></script>
<script src="{% static 'js/hyperscript-0.9.7.min.js' %}"></script>
{% endblock %}

{% block content %}
{% include 'navigation.html' %}

<div class="container">
  <div class="hello text-center justify-content-center">
    <h1>Hi {{ user.username }}!</h1>
    <p>You can see the {{jobs_count}} available jobs here. </p>
    <button class="btn btn-secondary post-button" hx-get="{% url 'post' %}" hx-target="#dialog">
      <i class="bi bi-pencil-square"></i>
    </button>
    <button class="btn btn-secondary chat-button">
      <i class="bi bi-chat-left"></i>
    </button>
    <button class="btn btn-secondary shop-button">
      <i class="bi bi-bag"></i>
    </button>
  </div>
  <form class="searchform d-flex justify-content-center" method ="get">
    <input class="searchbar" type="text" value='{{request.GET.search_title}}' name="search_title"/>
    <button class="btn btn-primary" type="submit">Search</button>
  </form>
  <div class="row d-flex justify-content-center">
    <div class="col jobs-scroll mb-5">
      {% for job in jobs %}
        <div class="card job-card mb-2">
          <div class="card-body">
            <div class="card-title d-flex justify-content-between mb-0">
              <h4><a href="{% url 'jobdetails' job.job_id %}">{{ job.job_title }}</a></h4>   
              <div class="dropdown">
                <button class="btn btn-secondary" 
                  type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" 
                  aria-haspopup="true" aria-expanded="false">
                  <i class="bi bi-list"></i>
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a class="dropdown-item" id="sfl{{ job.job_id }}" 
                    href="javascript:bookmark('{{ user.id }}','{{ job.job_id }}')">
                      {% if job.job_id in save_for_later %}
                        Unmark
                      {% else %}
                        Bookmark
                      {% endif %}
                  </a>
                  {% include 'htmx/report.html'%}
                </div>
              </div>
            </div>
            <div class="d-flex justify-content-start card-subtitle mb-1 text-muted">
              <a href="{% url 'userdetails' job.poster_id.id %}">
                <img src="../static/assets/pfp/{{job.poster_id.id}}.jpeg">
              </a>
              <h5><a href="{% url 'userdetails' job.poster_id.id %}">{{ job.poster_id.username }}</a></h5>
            </div>
            <p class="">{{ job.points }} Points · {{ job.posting_time | date:'d M Y' }} · {{ job.location }}</p>
            <p class="">{{ job.job_short_description }}</p>
            {% if job.job_id in jobs_applied %} 
              {% include 'htmx/applied.html' %}
            {% else %}
              <button class="btn btn-primary"
                id="btnApply{{ job.job_id }}"
                _="on click add @disabled to me"
                hx-post="{% url 'apply' %}"
                hx-vals='{"job_id": {{ job.job_id }} }'
                hx-swap="outerHTML"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>Apply</button>
            {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <button
      type="button"
      class="btn btn-danger btn-floating btn-lg"
      id="btn-back-to-top"
      >
      <i class="bi bi-arrow-up"></i>
  </button>
</div>

<script>
  // Bookmark a job.
  function bookmark(uid, jid) {
    $.ajax({
      type: "POST",
      url: "{% url 'generic' %}",
      data: { csrfmiddlewaretoken: '{{ csrf_token }}', func: "bookmark", uid: uid, jid: jid},
      success: function callback(response) {
        if ($("#sfl"+jid).text().trim() == 'Bookmark') {
          $("#sfl"+jid).text('Unmark');
          msg = "bookmarked";
        }
        else {
          $("#sfl"+jid).text('Bookmark');
          msg = "unmarked";
        }
        alert(`You've successfully ${msg} the job. You can view the changes on your profile.`)
      }
    });
  }
</script>

<script src="{% static 'js/home.js' %}"></script>
{% endblock %}