{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
  <a class="navbar-brand" href="{% url 'home' %}"><img class="img-fluid" width="60" height="70" src="../static/assets/logo_full.png"/></a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="{% url 'me' %}">My Profile</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'post' %}">Post a Job</a>
      </li>
    </ul>
    <ul class="navbar-nav ms-auto">
      <li class="nav-item">
        <a class="btn btn-outline-dark" href="{% url 'logout' %}">Log Out</a>
      </li>
    </ul>
  </div>
</nav>

<div class="container">

  <div class="hello text-center">
    <h1>Hi {{ user.username }}!</h1>
    <p>You can see the {{jobs_count}} available jobs here. </p>
  </div>
  <form class="searchform d-flex justify-content-center" method ="get">
    <input class="searchbar" type="text" value='{{request.GET.search_title}}' name="search_title"/>
    <button class="btn btn-primary" type="submit">Search</button>
  </form>
  <div class="row d-flex justify-content-center">
    <div class="col jobs-scroll mb-5">
      {% for job in jobs %}
        <div class="job-card" class="container">
          <div class="d-flex justify-content-between">
            <h4><a href="{% url 'jobdetails' job.job_id %}">{{ job.job_title }}</a></h4>
            <div class="dropdown">
              <button class="btn btn-secondary dropdown-toggle" 
                type="button" id="dropdownMenuButton" data-toggle="dropdown" 
                aria-haspopup="true" aria-expanded="false">Options
              </button>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" id="sfl{{ job.job_id }}" 
                  href="javascript:bookmark('{{ user.id }}','{{ job.job_id }}')">
                    {% if job.job_id in save_for_later %}
                      Unmark
                    {% else %}
                      Bookmark
                    {% endif %}
                </a>
                <a class="dropdown-item" 
                  href="javascript:report('{{ user.id }}','{{ job.job_id }}')">Report</a>
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-start">
            <a href="{% url 'userdetail' job.poster_id.id %}">
              <img src="../static/assets/pfp/{{job.poster_id.id}}.jpeg">
            </a>
            <h5><a href="{% url 'userdetail' job.poster_id.id %}">{{ job.poster_id.username }}</a></h5>
          </div>
          <p>{{ job.points }} Points · {{ job.posting_time }} · {{ job.location }}</p>
          <p>{{ job.job_short_description }}</p>
          <button
            {% if job.job_id in jobs_applied %} disabled {% endif %}
            class="btn btn-primary" 
            onclick="apply('{{user.id }}','{{ job.job_id }}')"
            id = "btnApply{{ job.job_id }}">
            {% if job.job_id in jobs_applied %} 
              Applied ✓
            {% else %}
              Apply
            {% endif %}
          </button>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  // Bookmark a job.
  function bookmark(uid, jid) {
    $.ajax({
      type: "POST",
      url: "{% url 'generic' %}",
      data: { csrfmiddlewaretoken: '{{ csrf_token }}', func: "bookmark", uid: uid, jid: jid},
      success: function callback(response) {
        if ($("#sfl"+jid).text().trim() == 'Bookmark') {
          $("#sfl"+jid).text('Unmark');
          msg = "bookmarked";
        }
        else {
          $("#sfl"+jid).text('Bookmark');
          msg = "unmarked";
        }
        alert(`You've successfully ${msg} the job. You can view the changes on your profile.`)
      }
    });
  }

  //Apply for a job.
  function apply(uid, jid) {
    $("#btnApply"+jid).attr("disabled", true);
    $.ajax({
      type: "POST", 
      url: "{% url 'generic' %}", 
      data: { csrfmiddlewaretoken: '{{ csrf_token }}', func: 'app', uid: uid, jid: jid}, 
      success: function callback(response) {
        $("#btnApply"+jid).text("Applied ✓");
        alert("You've applied for the job. You can now view the changes in your profile.")
      }
    });
  }

  //Report a job.
  function report(uid, jid) {
    $.ajax({
      type: "POST", 
      url: "{% url 'generic' %}", 
      data: { csrfmiddlewaretoken: '{{ csrf_token }}', func: 'report', uid: uid, jid: jid}, 
      success: function callback(response) {
        alert("Thank you for reporting the job. We will review your complaint shortly.")
      }
    });
  }
</script>
{% endblock %}